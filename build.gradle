/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

buildscript {
  repositories.jcenter()
}

ext {
  qname = "dm0275/minecraft-server"
  worldName = System.getenv("WORLD") ?: "world"
  vanillaDirectories = ["data/$worldName/world", "data/$worldName/mods"]
  vanillaVersions = [
      '1.13.2': [
          'url': 'https://launcher.mojang.com/v1/objects/3737db93722a9e39eeada7c27e7aca28b144ffa7/server.jar'
      ],
      '1.14.4': [
          'url': 'https://launcher.mojang.com/v1/objects/3dc3d84a581f14691199cf6831b71ed1296a9fdf/server.jar'
      ],
      '1.15.2': [
          'url': 'https://launcher.mojang.com/v1/objects/bb2b6b1aefcd70dfd1892149ac3a215f6c636b07/server.jar'
      ],
      '1.16.4': [
          'url': 'https://launcher.mojang.com/v1/objects/35139deedbd5182953cf1caa23835da59ca3d7cd/server.jar'
      ]
  ]
  forgeDirectories = ["data_forge/$worldName/world", "data_forge/$worldName/mods"]
  forgeVersions = [
      '1.13.2': [
          'forgeVersion': '25.0.219'
      ],
      '1.14.4': [
          'forgeVersion': '28.2.1'
      ],
      '1.15.2': [
          'forgeVersion': '31.2.0'
      ],
      '1.16.4': [
          'forgeVersion': '35.1.4'
      ]
  ]
  port = System.getenv("MC_PORT") ?:"25565"
  latestTag = "${qname}:latest"
  latestTagForge = "${qname}:forge-latest"
  minecraftVersion = System.getenv("MC_VERSION") ?: "latest"
  envVars = """export MC_IMAGE=${qname}:${minecraftVersion} \
    PORT=${port} \
    JAVA_MIN_MEM=3G \
    JAVA_MAX_MEM=3G \
    WORLD_DIR=\$PWD/data/${worldName}/world \
    MODS_DIR=\$PWD/data/${worldName}/mods"""
  envVarsForge = """export MC_IMAGE=${qname}:forge-${minecraftVersion} \
    PORT=${port} \
    JAVA_MIN_MEM=3G \
    JAVA_MAX_MEM=3G \
    WORLD_DIR=\$PWD/data_forge/${worldName}/world \
    MODS_DIR=\$PWD/data_forge/${worldName}/mods"""
}

task dockerLogin(type: Exec) {
  commandLine "bash", "-c",  """printenv DOCKER_TOKEN \
    | docker login -u "\$DOCKER_USERNAME" --password-stdin"""
}

task setup {
  group "Mincraft"
  description "Setup the Minecraft directories"
  doLast {
    vanillaDirectories.forEach { dir ->
      mkdir(dir)
    }
  }
}

task setupForge {
  group "Mincraft"
  description "Setup the Minecraft (forge) directories"
  doLast {
    forgeDirectories.forEach { dir ->
      mkdir(dir)
    }
  }
}

task cleanDirs(type: Delete) {
  doLast {
    vanillaDirectories.forEach { dir ->
      delete(dir)
    }
  }
}

task cleanDirsForge(type: Delete) {
  doLast {
    forgeDirectories.forEach { dir ->
      delete(dir)
    }
  }
}

task run(type: Exec) {
  group "Mincraft"
  description "Run the latest Minecraft server image"
  dependsOn setup
  commandLine "bash", "-c", "${envVars} && docker-compose up"
}

task runBackground(type: Exec) {
  group "Mincraft"
  description "Run the latest Minecraft server image (daemonized)"
  dependsOn setup
  commandLine "bash", "-c", "${envVars} && docker-compose run -d -p ${port}:25565 --name ${worldName}-minecraft minecraft"
}

task runForge(type: Exec) {
  group "Mincraft"
  description "Run the latest Forge Minecraft server image"
  dependsOn setupForge
  commandLine "bash", "-c", "${envVarsForge} && docker-compose up"
}

task runBackgroundForge(type: Exec) {
  group "Mincraft"
  description "Run the latest Forge Minecraft server image (daemonized)"
  dependsOn setupForge
  commandLine "bash", "-c", "${envVarsForge} && docker-compose run -d -p ${port}:25565 --name ${worldName}-forge minecraft"
}

task stop(type: Exec) {
  commandLine "bash", "-c", "${envVars} && docker-compose stop"
}

vanillaVersions.keySet().each { version ->
  String buildCmd = """docker build \
            --file vanilla/Dockerfile \
            --build-arg mc_version=${version} \
            --build-arg mc_url_link=${vanillaVersions.get(version)['url']} \
            -t ${qname}:${version}"""
  tasks.create(name: "buildVanilla${version}", type: Exec) {
    group "Mincraft"
    description "Build Minecraft server v${version} image"
    if (version == vanillaVersions.keySet().last()) {
      commandLine "${buildCmd} -t ${latestTag} .".tokenize()
    } else {
      commandLine "${buildCmd} .".tokenize()
    }
  }

  tasks.create(name: "pushVanilla${version}", dependsOn: dockerLogin, type: Exec) {
    group "Mincraft"
    description "Push Minecraft server v${version} image"
    if (version == vanillaVersions.keySet().last()) {
      commandLine "bash", "-c", """docker push ${qname}:${version} \
            && docker push ${latestTag}"""
    } else {
      commandLine "docker push ${qname}:${version}".tokenize()
    }
  }
}

task buildAllVanilla(dependsOn: tasks.matching { Task task -> task.name.startsWith("buildVanilla")})

task pushAllVanilla(dependsOn: tasks.matching { Task task -> task.name.startsWith("pushVanilla")})

forgeVersions.keySet().toArray().each {  version ->
  String buildCmd = """docker build \
        --file forge/Dockerfile \
        --build-arg mc_version=${version} \
        --build-arg forge_version=${forgeVersions.get(version)['forgeVersion']} \
        -t ${qname}:forge-${version}"""
  tasks.create(name: "buildForge${version}", type: Exec) {
    group "Mincraft"
    description "Build Forge Minecraft server v${version} image (forge v${forgeVersions.get(version)['forgeVersion']})"
    if (version == forgeVersions.keySet().toArray().last()) {
      commandLine "${buildCmd} -t ${latestTagForge} .".tokenize()
    } else {
      commandLine "${buildCmd} .".tokenize()
    }
  }

  tasks.create(name: "pushForge${version}", dependsOn: dockerLogin, type: Exec) {
    group "Mincraft"
    description "Push Forge Minecraft server v${version} image"
    if (version == forgeVersions.keySet().toArray().last()) {
      commandLine "bash", "-c", """docker push ${qname}:forge-${version} \
            && docker push ${latestTagForge}"""
    } else {
      commandLine "docker push ${qname}:forge-${version}".tokenize()
    }
  }
}

task buildAllForge(dependsOn: tasks.matching { Task task -> task.name.startsWith("buildForge")}) {
  group "Mincraft"
  description "Build All Minecraft server images"
}

task pushAllForge(dependsOn: tasks.matching { Task task -> task.name.startsWith("pushForge")}) {
  group "Mincraft"
  description "Build All Forge Minecraft server images"
}
